<script  lang="ts" setup>
import { useRouter, useRoute } from 'vue-router';
import { onMounted } from 'vue';
import { getUserAuthorize, getUserInfo } from './request/WeChat'
import { loginWeChat } from './request/index'
import { ElMessage } from 'element-plus';
const router = useRouter();
const route = useRoute();

const openid = window.localStorage.getItem('openid');
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const state = urlParams.get('state');
const isAuthorized = ref(false);//用一个变量来控制子组件加载
let isRequested = false //用一个变量来保证只发起一次请求，防止因为dom变化而导致重复请求
async function init() {
    //检查用户是否已经授权了
    const auth_token = localStorage.getItem('auth_token');
    if (auth_token!="") {
    isAuthorized.value = true;
  }
    //console.log('请求前：isRequested', isRequested)
    // console.log(openid)
    if (openid == null||auth_token=="") {
        if (!isRequested) {
            // 发送请求
            isRequested = true
            if (code && state) {
              //  console.log('code', code)
              //  console.log('state', state)
                // 调用获取用户信息的接口,得到用户的openid
                await getUserInfo(code).then(async openid => {
                    if (openid == null) {
                        console.log('openid == null')
                        router.push('/undefined');
                    }
                    // 保存 openid 到 localStorage
                    localStorage.setItem('openid', openid);
                    //请求授权得到auth_token
                    const res: any = await loginWeChat(openid)
                    // 将auth_token保存到localStorage
                    if (res.code == 200) {
                        localStorage.setItem('auth_token', res.token);
                      isAuthorized.value=true
                    }
                    else {
                        ElMessage({ message: `获得token失败,${res.message}`, type: 'success', });
                    }
                }).catch((err) => {
                    console.log(err)
                })
            }
            else {
              //  console.log('1')
                await getUserAuthorize().then((res: any) => {
                    console.log('res', res)
                    const url = res.url;
                    //console.log('url',url)
                    if (window.location.href !== url) {
                        window.location.href = url;
                    }
                    else {
                        console.log('window.location.href')
                        router.push('/undefined');
                    }
                }).catch((err) => {
                    //授权失败
                    console.log('授权失败',err)
                    router.push('/undefined');
                }).finally(() => {
                    // console.log('2')
                })

            }
        }
    }

}
onMounted(async () => {
    try {
        console.log('授权前isAuthorized',isAuthorized.value)
        await init();
        console.log('授权后isAuthorized',isAuthorized.value)
    } catch (err) {
        console.log(err);
        router.push('/undefined');
    } finally {
        // 关闭加载动画
    }
})

function footer_one_off() {
    router.push('/');
}

function footer_two_off() {
    router.push('/famous_doctor_hall');
}

function footer_three_off() {
    router.push('/personal_Information');
}

const activeIcon = computed(() => {
    if (route.path === '/') {
        return 1;
    } else if (route.path === '/famous_doctor_hall') {
        return 2;
    } else if (route.path === '/personal_Information') {
        return 3;
    }
    return null;
});

const footer_show = computed(() => {
    if (
        route.path === '/' ||
        route.path === '/personal_Information' ||
        route.path === '/famous_doctor_hall'
    ) {
        return true;
    }
    return false;
});
</script>

<template>
    <div v-if="footer_show" v-bind:key="$route.path" class="div_main">
        <div  v-if="isAuthorized"><router-view></router-view>
        </div>
        <div class="div_footer">
            <div v-if="activeIcon === 1" class="footer_on" @click="footer_one_off">
                <!-- <img :src=footer_one_ons /> -->
                <svg width="38.000000pt" height="38.000000pt"  viewBox="0 0 1024 1024"><path fill="#a21c1b" d="M362.666667 895.914667V639.850667c0-36.266667 33.109333-63.850667 72.533333-63.850667h153.6c39.253333 0 72.533333 27.648 72.533333 63.850667v256.064h59.904c61.269333 0 110.762667-47.957333 110.762667-106.730667V414.165333L557.162667 139.328a63.808 63.808 0 0 0-90.325334 0L192 414.165333v375.018667c0 58.88 49.386667 106.730667 110.762667 106.730667H362.666667z m42.666666 0h213.333334V639.850667c0-10.709333-12.586667-21.184-29.866667-21.184h-153.6c-17.408 0-29.866667 10.389333-29.866667 21.184v256.064z m469.333334-439.082667v332.352c0 82.645333-68.885333 149.397333-153.429334 149.397333H302.762667C218.133333 938.581333 149.333333 871.936 149.333333 789.184V456.832l-27.584 27.584a21.333333 21.333333 0 1 1-30.165333-30.165333L436.672 109.162667a106.474667 106.474667 0 0 1 150.656 0l345.088 345.088a21.333333 21.333333 0 0 1-30.165333 30.165333L874.666667 456.832z"></path></svg>
                <span style="color: #a21c1b;">首页</span>
            </div>
            <div v-else class="footer_off" @click="footer_one_off">
                <svg width="38.000000pt" height="38.000000pt"   viewBox="0 0 1024 1024"><path path fill="currentColor" d="M362.666667 895.914667V639.850667c0-36.266667 33.109333-63.850667 72.533333-63.850667h153.6c39.253333 0 72.533333 27.648 72.533333 63.850667v256.064h59.904c61.269333 0 110.762667-47.957333 110.762667-106.730667V414.165333L557.162667 139.328a63.808 63.808 0 0 0-90.325334 0L192 414.165333v375.018667c0 58.88 49.386667 106.730667 110.762667 106.730667H362.666667z m42.666666 0h213.333334V639.850667c0-10.709333-12.586667-21.184-29.866667-21.184h-153.6c-17.408 0-29.866667 10.389333-29.866667 21.184v256.064z m469.333334-439.082667v332.352c0 82.645333-68.885333 149.397333-153.429334 149.397333H302.762667C218.133333 938.581333 149.333333 871.936 149.333333 789.184V456.832l-27.584 27.584a21.333333 21.333333 0 1 1-30.165333-30.165333L436.672 109.162667a106.474667 106.474667 0 0 1 150.656 0l345.088 345.088a21.333333 21.333333 0 0 1-30.165333 30.165333L874.666667 456.832z"></path></svg>
                <span>首页</span>
            </div>
            <div v-if="activeIcon === 2" class="footer_on" @click="footer_two_off">
              <svg width="38.000000pt" height="38.000000pt" viewBox="0 0 1024 1024"><path fill="#a21c1b" d="M512 609.697959c-86.726531 0-157.257143-70.530612-157.257143-157.257143 0-36.04898 12.538776-71.053061 35.004082-99.265306l2.089796-2.612245 3.134694-2.089796c29.257143-17.763265 71.57551-28.212245 116.506122-28.212245s87.24898 10.44898 116.506122 28.212245l3.134694 2.089796 2.089796 2.612245c22.987755 27.689796 35.004082 63.216327 35.004082 99.265306 1.044898 86.726531-69.485714 157.257143-156.212245 157.257143zM420.04898 382.432653c-15.673469 20.37551-23.510204 44.408163-23.510204 70.008163 0 63.738776 51.722449 115.461224 115.461224 115.461225s115.461224-51.722449 115.461224-115.461225c0-25.6-8.359184-49.632653-23.510204-70.008163-22.465306-12.538776-56.42449-20.37551-91.95102-20.37551s-68.963265 7.836735-91.95102 20.37551zM543.346939 289.959184H480.653061c-11.493878 0-20.897959-9.404082-20.897959-20.89796s9.404082-20.897959 20.897959-20.897959h62.693878c11.493878 0 20.897959 9.404082 20.897959 20.897959s-9.404082 20.897959-20.897959 20.89796z"></path><path  fill="#a21c1b" d="M512 321.306122c-11.493878 0-20.897959-9.404082-20.897959-20.897959v-62.693877c0-11.493878 9.404082-20.897959 20.897959-20.897959s20.897959 9.404082 20.897959 20.897959v62.171428c0 12.016327-9.404082 21.420408-20.897959 21.420408zM512 851.591837c-67.918367 0-131.657143-7.836735-179.2-22.465306-77.322449-23.510204-93.518367-59.559184-93.518367-85.159184 0-94.563265 66.873469-178.677551 170.318367-213.681633l12.016327-4.179592 9.404081 8.881633c21.942857 21.420408 50.155102 32.914286 80.457143 32.914286 30.302041 0 59.036735-11.493878 80.457143-32.914286l9.404082-8.881633 12.016326 4.179592c103.444898 35.526531 170.318367 119.118367 170.318367 213.681633 1.044898 79.412245-145.763265 107.62449-271.673469 107.62449z m-99.787755-277.942857c-79.934694 31.346939-130.612245 97.17551-130.612245 170.318367 0 31.869388 92.473469 65.828571 230.922449 65.828571s230.922449-33.959184 230.922449-65.828571c0-73.142857-50.677551-138.44898-130.612245-170.318367-28.212245 22.987755-63.216327 36.04898-99.787755 36.048979-37.616327 0-72.620408-12.538776-100.832653-36.048979z"></path><path  fill="#a21c1b" d="M648.359184 430.497959c-11.493878 0-20.897959-9.404082-20.89796-20.897959 0-19.330612-44.930612-47.020408-115.461224-47.020408s-115.461224 28.212245-115.461224 47.020408c0 11.493878-9.404082 20.897959-20.89796 20.897959s-20.897959-9.404082-20.897959-20.897959V261.22449c0-50.677551 67.395918-88.816327 157.257143-88.816327s157.257143 38.138776 157.257143 88.816327v147.853061c0 12.016327-9.404082 21.420408-20.897959 21.420408zM512 320.261224c46.497959 0 87.24898 10.44898 115.461224 27.167347V261.22449c0-19.330612-44.930612-47.020408-115.461224-47.020408s-115.461224 28.212245-115.461224 47.020408v86.204081c28.212245-16.718367 68.963265-27.167347 115.461224-27.167347z"></path><path  fill="#a21c1b" d="M199.053061 773.22449c-1.567347 0-3.134694 0-4.702041-0.522449C111.281633 753.893878 94.040816 719.934694 94.040816 694.857143c0-67.918367 42.318367-129.044898 110.759184-161.959184-12.538776-20.37551-19.330612-43.885714-19.330612-67.918367 0-8.359184 1.044898-16.195918 2.089796-24.555102-1.567347-3.134694-2.089796-6.269388-2.089796-9.404082V313.991837C184.946939 271.673469 240.326531 239.281633 313.469388 239.281633c5.746939 0 10.971429 2.089796 15.15102 6.269387 4.179592 4.179592 6.269388 9.404082 5.746939 15.151021v1.044898c-0.522449 10.971429-9.404082 20.37551-20.897959 20.37551-2.089796 0-4.179592-0.522449-6.269388-1.044898-50.155102 1.567347-80.457143 21.420408-80.457143 32.914286V376.163265c6.791837-1.044898 14.106122 1.567347 18.808163 6.791837 6.791837 7.836735 6.791837 18.808163 0.522449 27.167347-12.538776 15.673469-19.330612 34.481633-19.330612 54.857143 0 23.510204 9.404082 45.453061 26.122449 62.171428 7.836735 7.314286 8.359184 19.853061 1.567347 28.212245-2.612245 3.657143-6.269388 5.746939-10.44898 6.791837C178.155102 584.620408 135.836735 636.865306 135.836735 694.857143c0 10.971429 20.897959 26.122449 67.918367 37.093877 11.493878 2.612245 18.285714 13.583673 15.673469 25.077551-2.089796 9.404082-10.44898 16.195918-20.37551 16.195919z"></path><path  fill="#a21c1b" d="M824.946939 773.22449c-9.404082 0-18.285714-6.791837-20.37551-16.195919-2.612245-11.493878 4.702041-22.465306 15.673469-25.077551 47.020408-10.44898 67.918367-26.122449 67.918367-37.093877 0-57.991837-42.318367-110.236735-108.146938-133.22449-4.179592-1.044898-7.836735-3.657143-10.44898-6.791837-6.791837-8.359184-6.269388-20.37551 1.567347-28.212245 16.718367-16.195918 26.122449-38.661224 26.122449-62.171428 0-20.37551-6.791837-39.183673-19.330612-54.857143-6.269388-7.836735-6.269388-19.330612 0.522449-27.167347 4.702041-5.746939 12.016327-7.836735 18.808163-6.791837V313.991837c0-10.971429-30.302041-31.346939-80.457143-32.914286-2.089796 0.522449-4.179592 1.044898-6.269388 1.044898-11.493878 0-20.37551-8.881633-20.897959-20.37551v-1.044898c0-5.746939 2.089796-10.971429 5.746939-15.151021 4.179592-4.179592 9.404082-6.269388 15.15102-6.269387 73.142857 0 128.522449 31.869388 128.522449 74.710204v117.028571c0 3.657143-1.044898 6.791837-2.089796 9.404082 1.567347 7.836735 2.089796 16.195918 2.089796 24.555102 0 24.555102-6.791837 48.065306-19.330612 67.918367 67.918367 32.914286 110.759184 94.040816 110.759184 161.959184 0 25.077551-17.240816 59.036735-100.832653 77.844898-2.089796 0.522449-3.657143 0.522449-4.702041 0.522449z"></path></svg>
                <span style="color: #a21c1b;">名医堂</span>
            </div>
            <div v-else class="footer_off" @click="footer_two_off">
             <svg width="38.000000pt" height="38.000000pt" viewBox="0 0 1024 1024"><path fill="currentColor" d="M512 609.697959c-86.726531 0-157.257143-70.530612-157.257143-157.257143 0-36.04898 12.538776-71.053061 35.004082-99.265306l2.089796-2.612245 3.134694-2.089796c29.257143-17.763265 71.57551-28.212245 116.506122-28.212245s87.24898 10.44898 116.506122 28.212245l3.134694 2.089796 2.089796 2.612245c22.987755 27.689796 35.004082 63.216327 35.004082 99.265306 1.044898 86.726531-69.485714 157.257143-156.212245 157.257143zM420.04898 382.432653c-15.673469 20.37551-23.510204 44.408163-23.510204 70.008163 0 63.738776 51.722449 115.461224 115.461224 115.461225s115.461224-51.722449 115.461224-115.461225c0-25.6-8.359184-49.632653-23.510204-70.008163-22.465306-12.538776-56.42449-20.37551-91.95102-20.37551s-68.963265 7.836735-91.95102 20.37551zM543.346939 289.959184H480.653061c-11.493878 0-20.897959-9.404082-20.897959-20.89796s9.404082-20.897959 20.897959-20.897959h62.693878c11.493878 0 20.897959 9.404082 20.897959 20.897959s-9.404082 20.897959-20.897959 20.89796z"></path><path d="M512 321.306122c-11.493878 0-20.897959-9.404082-20.897959-20.897959v-62.693877c0-11.493878 9.404082-20.897959 20.897959-20.897959s20.897959 9.404082 20.897959 20.897959v62.171428c0 12.016327-9.404082 21.420408-20.897959 21.420408zM512 851.591837c-67.918367 0-131.657143-7.836735-179.2-22.465306-77.322449-23.510204-93.518367-59.559184-93.518367-85.159184 0-94.563265 66.873469-178.677551 170.318367-213.681633l12.016327-4.179592 9.404081 8.881633c21.942857 21.420408 50.155102 32.914286 80.457143 32.914286 30.302041 0 59.036735-11.493878 80.457143-32.914286l9.404082-8.881633 12.016326 4.179592c103.444898 35.526531 170.318367 119.118367 170.318367 213.681633 1.044898 79.412245-145.763265 107.62449-271.673469 107.62449z m-99.787755-277.942857c-79.934694 31.346939-130.612245 97.17551-130.612245 170.318367 0 31.869388 92.473469 65.828571 230.922449 65.828571s230.922449-33.959184 230.922449-65.828571c0-73.142857-50.677551-138.44898-130.612245-170.318367-28.212245 22.987755-63.216327 36.04898-99.787755 36.048979-37.616327 0-72.620408-12.538776-100.832653-36.048979z"></path><path d="M648.359184 430.497959c-11.493878 0-20.897959-9.404082-20.89796-20.897959 0-19.330612-44.930612-47.020408-115.461224-47.020408s-115.461224 28.212245-115.461224 47.020408c0 11.493878-9.404082 20.897959-20.89796 20.897959s-20.897959-9.404082-20.897959-20.897959V261.22449c0-50.677551 67.395918-88.816327 157.257143-88.816327s157.257143 38.138776 157.257143 88.816327v147.853061c0 12.016327-9.404082 21.420408-20.897959 21.420408zM512 320.261224c46.497959 0 87.24898 10.44898 115.461224 27.167347V261.22449c0-19.330612-44.930612-47.020408-115.461224-47.020408s-115.461224 28.212245-115.461224 47.020408v86.204081c28.212245-16.718367 68.963265-27.167347 115.461224-27.167347z"></path><path d="M199.053061 773.22449c-1.567347 0-3.134694 0-4.702041-0.522449C111.281633 753.893878 94.040816 719.934694 94.040816 694.857143c0-67.918367 42.318367-129.044898 110.759184-161.959184-12.538776-20.37551-19.330612-43.885714-19.330612-67.918367 0-8.359184 1.044898-16.195918 2.089796-24.555102-1.567347-3.134694-2.089796-6.269388-2.089796-9.404082V313.991837C184.946939 271.673469 240.326531 239.281633 313.469388 239.281633c5.746939 0 10.971429 2.089796 15.15102 6.269387 4.179592 4.179592 6.269388 9.404082 5.746939 15.151021v1.044898c-0.522449 10.971429-9.404082 20.37551-20.897959 20.37551-2.089796 0-4.179592-0.522449-6.269388-1.044898-50.155102 1.567347-80.457143 21.420408-80.457143 32.914286V376.163265c6.791837-1.044898 14.106122 1.567347 18.808163 6.791837 6.791837 7.836735 6.791837 18.808163 0.522449 27.167347-12.538776 15.673469-19.330612 34.481633-19.330612 54.857143 0 23.510204 9.404082 45.453061 26.122449 62.171428 7.836735 7.314286 8.359184 19.853061 1.567347 28.212245-2.612245 3.657143-6.269388 5.746939-10.44898 6.791837C178.155102 584.620408 135.836735 636.865306 135.836735 694.857143c0 10.971429 20.897959 26.122449 67.918367 37.093877 11.493878 2.612245 18.285714 13.583673 15.673469 25.077551-2.089796 9.404082-10.44898 16.195918-20.37551 16.195919z"></path><path d="M824.946939 773.22449c-9.404082 0-18.285714-6.791837-20.37551-16.195919-2.612245-11.493878 4.702041-22.465306 15.673469-25.077551 47.020408-10.44898 67.918367-26.122449 67.918367-37.093877 0-57.991837-42.318367-110.236735-108.146938-133.22449-4.179592-1.044898-7.836735-3.657143-10.44898-6.791837-6.791837-8.359184-6.269388-20.37551 1.567347-28.212245 16.718367-16.195918 26.122449-38.661224 26.122449-62.171428 0-20.37551-6.791837-39.183673-19.330612-54.857143-6.269388-7.836735-6.269388-19.330612 0.522449-27.167347 4.702041-5.746939 12.016327-7.836735 18.808163-6.791837V313.991837c0-10.971429-30.302041-31.346939-80.457143-32.914286-2.089796 0.522449-4.179592 1.044898-6.269388 1.044898-11.493878 0-20.37551-8.881633-20.897959-20.37551v-1.044898c0-5.746939 2.089796-10.971429 5.746939-15.151021 4.179592-4.179592 9.404082-6.269388 15.15102-6.269387 73.142857 0 128.522449 31.869388 128.522449 74.710204v117.028571c0 3.657143-1.044898 6.791837-2.089796 9.404082 1.567347 7.836735 2.089796 16.195918 2.089796 24.555102 0 24.555102-6.791837 48.065306-19.330612 67.918367 67.918367 32.914286 110.759184 94.040816 110.759184 161.959184 0 25.077551-17.240816 59.036735-100.832653 77.844898-2.089796 0.522449-3.657143 0.522449-4.702041 0.522449z"></path></svg>
                <span>名医堂</span>
            </div>
            <div v-if="activeIcon === 3" class="footer_on" @click="footer_three_off">
                <svg width="38.000000pt" height="38.000000pt"  viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-ea893728=""><path fill="#a21c1b" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg>
               
                <span style="color: #a21c1b;">我的信息</span>
            </div>
            <div v-else class="footer_off" @click="footer_three_off">
                <svg width="38.000000pt" height="38.000000pt"  viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-ea893728=""><path fill="currentColor" d="M512 512a192 192 0 1 0 0-384 192 192 0 0 0 0 384zm0 64a256 256 0 1 1 0-512 256 256 0 0 1 0 512zm320 320v-96a96 96 0 0 0-96-96H288a96 96 0 0 0-96 96v96a32 32 0 1 1-64 0v-96a160 160 0 0 1 160-160h448a160 160 0 0 1 160 160v96a32 32 0 1 1-64 0z"></path></svg>
                <span>我的信息</span>
            </div>
        </div>
    </div>
    <div v-else class="div_mains">
        <div  v-if="isAuthorized"> <router-view></router-view></div>
    </div>
</template>

<style lang="less" scoped>
html {
    font-size: 16px;
    background-color: #f5f5f5;
}

/* 小屏幕手机 */
@media (max-width: 400px) {
    body {
        font-size: 14px;
    }
}

/* 中等屏幕手机 */
@media (min-width: 401px) and (max-width: 600px) {
    body {
        font-size: 16px;
    }
}

/* 大屏幕手机 */
@media (min-width: 601px) and (max-width:800px) {
    body {
        font-size: 18px;
    }
}

/* 超大屏幕手机 */
@media (min-width: 801px) {
    body {
        font-size: 20px;
    }
}

.div_main {
    position: relative;
    overflow-y: scroll;
    height: 85%;
    width: 100%;
    background-color: #ececec;
}

.div_mains {
    position: relative;
    overflow-y: scroll;
    height: 95%;
    width: 100%;
    background-color: #ececec;
    padding-bottom: 1rem;
}

.slide-fade-enter-active,
.slide-fade-leave-active {
    transition: all 0.5s ease;
}

.slide-fade-enter,
.slide-fade-leave-to {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
}

.slide-fade-enter {
    transform: translateX(100%);
}

.slide-fade-leave-to {
    transform: translateX(-100%);
}

.div_footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #fbf7f6;
    height: 15%;
    display: flex;
    font-size: 1rem;

    .footer_off,
    .footer_on {
        width: 30%;
        margin: auto;
        display: flex;
        flex-direction: column;
        align-items: center;

        img {
            height: 3rem;
            width: 3rem;

        }
    }
}
</style>
